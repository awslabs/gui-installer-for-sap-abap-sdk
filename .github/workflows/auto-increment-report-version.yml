name: Auto-Increment ABAP Version
on:
  push:
    branches: [main]

jobs:
  increment-version:
    # Skip if commit was made by the bot (prevent infinite loop)
    if: "!contains(github.event.head_commit.message, '[skip actions]')"
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v3

      - name: Check version constant exists
        id: check_gc_version_exists
        run: |
          REPORT_FILE="src/#awslabs#sdk_installer.prog.abap"
          if ! grep -qE "gc_version\s+TYPE\s+string\s+VALUE" "$REPORT_FILE"; then
            echo "gc_version_exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  No gc_version constant found"
          else
            echo "gc_version_exists=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Increment version in ABAP report
        id: increment_version_report
        if: steps.check_gc_version_exists.outputs.gc_version_exists == 'true'
        run: |
          REPORT_FILE="src/#awslabs#sdk_installer.prog.abap"
          
          # Extract current version (e.g., '1.0.0')
          CURRENT=$(grep -oP "gc_version\s+TYPE\s+string\s+VALUE\s+'\K[^']+" "$REPORT_FILE")
          echo "Current version: $CURRENT"
          
          # Split version into parts
          MAJOR=$(echo $CURRENT | cut -d. -f1)
          MINOR=$(echo $CURRENT | cut -d. -f2)
          PATCH=$(echo $CURRENT | cut -d. -f3)
          
          # Determine version bump based on commit message
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          echo "Commit message: $COMMIT_MSG"
          
          if [[ "$COMMIT_MSG" == *"BREAKING"* ]] || [[ "$COMMIT_MSG" == *"major"* ]]; then
            # Major version bump: 1.2.3 â†’ 2.0.0
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
            echo "ðŸš€ Major version bump detected"
          elif [[ "$COMMIT_MSG" == *"feat:"* ]] || [[ "$COMMIT_MSG" == *"minor"* ]]; then
            # Minor version bump: 1.2.3 â†’ 1.3.0
            MINOR=$((MINOR + 1))
            PATCH=0
            echo "âœ¨ Minor version bump detected"
          else
            # Patch version bump (default): 1.2.3 â†’ 1.2.4
            PATCH=$((PATCH + 1))
            echo "ðŸ”§ Patch version bump (default)"
          fi
          
          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          echo "New version: $NEW_VERSION"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          
          # Get current date and commit
          BUILD_DATE=$(date +'%Y-%m-%d %H:%M:%S UTC')
          COMMIT_SHA="${GITHUB_SHA:0:7}"
          
          # Replace version
          # Replace entire line containing gc_version
          sed -i -E "s/^([[:space:]]*)gc_version[[:space:]]+TYPE[[:space:]]+string[[:space:]]+VALUE[[:space:]]+'[^']*'(.*)/\1gc_version TYPE string VALUE '$NEW_VERSION'\2/" "$REPORT_FILE"
          
          # Replace commit if it exists
          if grep -qE "gc_commit\s+TYPE\s+string\s+VALUE" "$REPORT_FILE"; then
            sed -i -E "s/^([[:space:]]*)gc_commit[[:space:]]+TYPE[[:space:]]+string[[:space:]]+VALUE[[:space:]]+'[^']*'(.*)/\1gc_commit  TYPE string VALUE '$COMMIT_SHA'\2/" "$REPORT_FILE"
            echo "Updated gc_commit to $COMMIT_SHA"
          else
            echo "âš ï¸  gc_commit not found, skipping"
          fi
          
          # Replace date if it exists
          if grep -qE "gc_date\s+TYPE\s+string\s+VALUE\s+" "$REPORT_FILE"; then
            sed -i -E "s/^([[:space:]]*)gc_date[[:space:]]+TYPE[[:space:]]+string[[:space:]]+VALUE[[:space:]]+'[^']*'(.*)/\1gc_date    TYPE string VALUE '$BUILD_DATE'\2/" "$REPORT_FILE"
            echo "Updated gc_date to $BUILD_DATE"
          else
            echo "âš ï¸  gc_date not found, skipping"
          fi
      
      - name: Create version info file
        id: create_version_file
        if: steps.check_gc_version_exists.outputs.gc_version_exists == 'true'
        run: |
          VERSION_FILE="src/version.txt"
          
          VERSION="${{ steps.increment_version_report.outputs.version }}"
          COMMIT_SHA="${GITHUB_SHA:0:7}"
          BUILD_DATE=$(date +'%Y-%m-%d %H:%M:%S UTC')
          
          # Create a simple text file with version info
          cat > $VERSION_FILE << EOF
          VERSION=$VERSION
          COMMIT=$COMMIT_SHA
          DATE=$BUILD_DATE
          EOF
          
          echo "Created version.txt:"
          cat src/version.txt
      
      - name: Commit updated version
        id: commit_updated_version
        if: steps.check_gc_version_exists.outputs.gc_version_exists == 'true'
        run: |
          REPORT_FILE="src/#awslabs#sdk_installer.prog.abap"
          VERSION_FILE="src/version.txt"
          
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add $REPORT_FILE
          git add $VERSION_FILE
          
          # Use original commit message with [skip actions] tag
          ORIGINAL_MSG="${{ github.event.head_commit.message }}"
          git commit -m "$ORIGINAL_MSG [skip actions]" || exit 0
          git push
